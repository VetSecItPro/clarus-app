# Security Audit Report

**Date:** 2026-01-14 12:00:00
**Project:** Vajra Truth Checker
**Audited by:** Claude Security Audit

---

## Executive Summary

| Severity | Count |
|----------|-------|
| Critical | 1 |
| High | 5 |
| Medium | 6 |
| Low | 3 |
| Info | 4 |
| Auto-fixed | 1 |

**Overall Risk Level:** HIGH

---

## Auto-Fixed Issues

These issues were automatically resolved during the audit:

| ID | Category | Description | Severity |
|----|----------|-------------|----------|
| FIXED-001 | Headers | Added security headers (X-Frame-Options, X-Content-Type-Options, X-XSS-Protection, Referrer-Policy, Permissions-Policy) | Medium |

---

## Outstanding Issues Requiring Manual Review

### Critical

#### FIX-001: Vulnerable Dependency - jsPDF Path Traversal
- **File:** `package.json`
- **Category:** Dependencies
- **Description:** jsPDF version 3.0.4 has a Local File Inclusion/Path Traversal vulnerability (GHSA-f8cm-6447-x5h2). This could allow attackers to read arbitrary files on the server.
- **Remediation:** Update jsPDF to version >=4.0.0
- **Suggested Fix:**
  ```bash
  pnpm update jspdf@^4.0.0
  ```

---

### High

#### FIX-002: Overly Permissive RLS Policy - active_chat_prompt
- **File:** Database Table `public.active_chat_prompt`
- **Category:** Supabase Security
- **Description:** Table has an RLS policy "Allow authenticated update chat prompt" for UPDATE that allows unrestricted access (USING and WITH CHECK are always true). Any authenticated user can modify chat prompts.
- **Remediation:** Update RLS policy to restrict updates to admin users only
- **Suggested Fix:**
  ```sql
  DROP POLICY IF EXISTS "Allow authenticated update chat prompt" ON public.active_chat_prompt;
  CREATE POLICY "Only admins can update chat prompt" ON public.active_chat_prompt
    FOR UPDATE
    USING (auth.uid() IN (SELECT id FROM users WHERE is_admin = true))
    WITH CHECK (auth.uid() IN (SELECT id FROM users WHERE is_admin = true));
  ```

#### FIX-003: Overly Permissive RLS Policy - active_summarizer_prompt
- **File:** Database Table `public.active_summarizer_prompt`
- **Category:** Supabase Security
- **Description:** Table has an RLS policy "Allow authenticated modify summarizer prompt" for ALL that allows unrestricted access. Any authenticated user can modify summarizer prompts.
- **Remediation:** Restrict to admin users only
- **Suggested Fix:**
  ```sql
  DROP POLICY IF EXISTS "Allow authenticated modify summarizer prompt" ON public.active_summarizer_prompt;
  CREATE POLICY "Only admins can modify summarizer prompt" ON public.active_summarizer_prompt
    FOR ALL
    USING (auth.uid() IN (SELECT id FROM users WHERE is_admin = true))
    WITH CHECK (auth.uid() IN (SELECT id FROM users WHERE is_admin = true));
  ```

#### FIX-004: Vulnerable Dependency - qs DoS
- **File:** `package.json` (via stripe dependency)
- **Category:** Dependencies
- **Description:** qs version <6.14.1 (transitive dependency via stripe) has an arrayLimit bypass vulnerability allowing DoS via memory exhaustion (GHSA-6rw7-vpxm-498p).
- **Remediation:** Update stripe package to latest version which includes patched qs
- **Suggested Fix:**
  ```bash
  pnpm update stripe@latest
  ```

#### FIX-005: OTP Expiry Too Long
- **File:** Supabase Auth Configuration
- **Category:** Authentication
- **Description:** Email OTP expiry is set to more than one hour. Long-lived OTPs increase the risk of code interception or reuse.
- **Remediation:** Set OTP expiry to less than 1 hour (recommended: 10-15 minutes)
- **More Info:** https://supabase.com/docs/guides/platform/going-into-prod#security

#### FIX-006: Leaked Password Protection Disabled
- **File:** Supabase Auth Configuration
- **Category:** Authentication
- **Description:** Supabase Auth's leaked password protection (HaveIBeenPwned check) is disabled. Users may set passwords that have been exposed in data breaches.
- **Remediation:** Enable leaked password protection in Supabase Auth settings
- **More Info:** https://supabase.com/docs/guides/auth/password-security#password-strength-and-leaked-password-protection

---

### Medium

#### FIX-007: Error Messages Expose Internal Details
- **File:** Multiple API routes
- **Category:** Error Handling
- **Description:** Several API endpoints return raw `error.message` in responses which may leak internal implementation details to attackers.
- **Affected Files:**
  - `app/api/share/route.ts:97,103`
  - `app/api/stripe/checkout/route.ts:144`
  - `app/api/stripe/webhook/route.ts:56,200`
  - `app/api/stripe/portal/route.ts:58`
  - `app/api/chat/route.ts:371`
  - `app/api/admin/mrr/route.ts:212`
- **Remediation:** Return generic error messages to clients, log detailed errors server-side only
- **Suggested Fix:**
  ```typescript
  // Instead of:
  return NextResponse.json({ error: error.message }, { status: 500 })

  // Use:
  console.error("Operation failed:", error)
  return NextResponse.json({ error: "An internal error occurred" }, { status: 500 })
  ```

#### FIX-008: Postgres Version Has Security Patches
- **File:** Supabase Database
- **Category:** Infrastructure
- **Description:** Current Postgres version (supabase-postgres-17.4.1.041) has outstanding security patches available.
- **Remediation:** Upgrade Postgres database through Supabase dashboard
- **More Info:** https://supabase.com/docs/guides/platform/upgrading

#### FIX-009: API Route Missing Authentication - /api/tags
- **File:** `app/api/tags/route.ts`
- **Category:** Authorization
- **Description:** The GET endpoint for `/api/tags` has no authentication check. While it only returns aggregate tag data, it should ideally require authentication.
- **Remediation:** Add authentication check or ensure data returned is intentionally public

#### FIX-010: Math.random for UI Randomization
- **File:** `app/page.tsx:120`
- **Category:** Cryptography
- **Description:** `Math.random()` is used for selecting random prompts. While this is only for UI and not security-critical, it's good to note.
- **Code:**
  ```typescript
  return rotatingPrompts[Math.floor(Math.random() * rotatingPrompts.length)]
  ```
- **Remediation:** No action needed - this is acceptable for non-security UI purposes

#### FIX-011: console.log Statements in Production Code
- **File:** Multiple files in app/api/
- **Category:** Information Disclosure
- **Description:** Debug console.log statements exist in production API routes which may leak sensitive information in logs.
- **Affected Files:**
  - `app/api/process-content/route.ts`
  - `app/api/stripe/webhook/route.ts`
- **Remediation:** Remove or replace with proper structured logging that excludes sensitive data

#### FIX-012: Service Role Key Used in Multiple Client-Side Accessible Routes
- **File:** Multiple API routes
- **Category:** Configuration
- **Description:** SUPABASE_SERVICE_ROLE_KEY is used correctly on server-side only, but ensure these routes are never exposed to client-side bundling.
- **Remediation:** Verify through build output that service role key is never in client bundles (currently appears safe)

---

### Low

#### FIX-013: SQL Migration Files in Repository
- **File:** `scripts/*.sql`
- **Category:** File Security
- **Description:** 20+ SQL migration files exist in the scripts directory. While this is normal for version control, ensure they don't contain sensitive data.
- **Remediation:** Review migration files to ensure no hardcoded sensitive data

#### FIX-014: exec() Pattern in UI Components
- **File:** `components/ui/highlighted-transcript.tsx`, `components/ui/transcript-viewer.tsx`
- **Category:** Code Patterns
- **Description:** regex.exec() is used for parsing transcripts. While not a security issue, ensure input is validated before processing.
- **Remediation:** No action needed - the exec() calls are for regex matching, not command execution

#### FIX-015: localStorage Usage for Non-Sensitive Data
- **File:** Multiple components
- **Category:** Client-Side Security
- **Description:** localStorage is used for cookie consent, SWR caching, and chat panel state. These appear to be non-sensitive.
- **Remediation:** Ensure no tokens, passwords, or PII are stored in localStorage

---

### Info

#### INFO-001: Rate Limiting Implemented
- **Status:** Good
- **Description:** Rate limiting is properly implemented using the `checkRateLimit` function across API routes including `/api/process-content`, `/api/chat`, `/api/stripe/checkout`, `/api/user/update-name`.

#### INFO-002: Input Validation Library Present
- **Status:** Good
- **Description:** Comprehensive validation library at `lib/validation.ts` with SQL injection detection, XSS prevention, UUID validation, and URL sanitization.

#### INFO-003: SSRF Protection in URL Validation
- **Status:** Good
- **Description:** URL validation blocks localhost, internal IPs (192.168.x, 10.x, 172.16.x), and dangerous schemes (javascript:, data:, etc.).

#### INFO-004: RLS Enabled on All Tables
- **Status:** Good
- **Description:** All 13 public tables have Row Level Security enabled. Note the policy issues mentioned in FIX-002 and FIX-003.

---

## Checks Performed

- [x] Dependency vulnerabilities (pnpm audit)
- [x] Secrets detection
- [x] SQL/XSS/Command injection
- [x] Authentication & authorization
- [x] Supabase RLS policies
- [x] API rate limiting
- [x] Input validation
- [x] Security headers
- [x] Environment configuration
- [x] Cryptography
- [x] Client-side security
- [x] Data privacy
- [x] React/Next.js specific
- [x] Error handling
- [x] Business logic

---

## Next Steps

1. **CRITICAL:** Run `pnpm update jspdf@^4.0.0` to fix path traversal vulnerability
2. **HIGH:** Fix RLS policies for active_chat_prompt and active_summarizer_prompt tables
3. **HIGH:** Update Stripe dependency to get patched qs version
4. **HIGH:** Enable leaked password protection in Supabase Auth settings
5. **HIGH:** Reduce OTP expiry to less than 1 hour
6. **MEDIUM:** Update API error handlers to not expose internal error messages
7. **MEDIUM:** Upgrade Postgres version through Supabase dashboard

Run `/sec-fix [FIX-XXX]` to fix specific issues.

---

*Generated by Claude Security Audit*
